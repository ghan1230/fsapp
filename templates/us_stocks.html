<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미국 주식 분석</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #2c3e50;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        .header {
            background: #1a1f36;
            color: white;
            padding: 20px 40px;
            border-bottom: 1px solid #2d3748;
        }
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
            color: white;
        }
        .header p {
            font-size: 0.95em;
            opacity: 0.7;
            margin-bottom: 15px;
            font-weight: 400;
            color: white;
        }
        .nav-links {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .nav-links a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9em;
        }
        .nav-links a:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-color: rgba(255,255,255,0.2);
        }
        .nav-links a.active {
            background: #3182ce;
            color: white;
            border-color: #3182ce;
        }
        .search-section {
            margin: 30px 40px;
            padding: 24px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .search-section h2 {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2d3748;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .search-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .search-box button {
            padding: 10px 20px;
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .search-box button:hover {
            background: #2c5aa0;
        }
        .search-results {
            margin-top: 15px;
        }
        .stock-item {
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            background: #f7fafc;
            transition: all 0.2s;
        }
        .stock-item:hover {
            background: #edf2f7;
            border-color: #3182ce;
        }
        .stock-data {
            display: none;
            margin-top: 30px;
        }
        .stock-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-card {
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .info-card h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.1em;
            font-weight: 600;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .chart-container {
            margin-top: 30px;
            height: 400px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #c53030;
            background: #fff5f5;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #fc8181;
        }
        .success {
            color: #2f855a;
            background: #f0fff4;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #68d391;
        }
        .loading {
            color: #718096;
        }
        .news-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 10px;
        }
        .news-item:last-child {
            border-bottom: none;
        }
        .news-item h4 {
            margin: 0 0 8px 0;
            font-size: 0.95em;
            font-weight: 600;
            color: #2d3748;
        }
        .news-item a {
            color: #3182ce;
            text-decoration: none;
        }
        .news-item a:hover {
            text-decoration: underline;
        }
        .news-item .news-meta {
            font-size: 0.85em;
            color: #718096;
            margin-top: 4px;
        }
        .news-item .news-summary {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 6px;
            line-height: 1.5;
        }
        .sentiment-positive {
            color: #38a169;
            font-weight: 600;
        }
        .sentiment-negative {
            color: #e53e3e;
            font-weight: 600;
        }
        .sentiment-neutral {
            color: #718096;
            font-weight: 600;
        }
        .dividend-chart {
            margin-top: 15px;
            height: 200px;
        }
        .peers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .peers-table th {
            background: #f7fafc;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9em;
        }
        .peers-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }
        .peers-table tr:hover {
            background: #f7fafc;
        }
        .positive {
            color: #38a169;
        }
        .negative {
            color: #e53e3e;
        }
        .news-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 14px;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            background: #edf2f7;
        }
        .filter-btn.active {
            background: #3182ce;
            color: white;
            border-color: #3182ce;
        }
        .dividend-growth {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .dividend-growth.positive {
            background: #c6f6d5;
            color: #22543d;
        }
        .dividend-growth.negative {
            background: #fed7d7;
            color: #742a2a;
        }
        .dividend-calendar {
            background: #edf2f7;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #3182ce;
        }
        .dividend-calendar strong {
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>US Stock Analysis</h1>
            <p>미국 상장 기업 재무제표 및 주가 분석</p>
            <div class="nav-links">
                <a href="/">한국 주식</a>
                <a href="/us_stocks" class="active">미국 주식</a>
                <a href="/compare">비교 분석</a>
                <a href="/settings" style="background: #3182ce; color: white; border-color: #3182ce;">⚙️ API 키 설정</a>
            </div>
        </div>

        <div class="search-section">
            <h2>Search Stocks</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="회사명 또는 심볼 입력 (예: Apple, AAPL)" />
                <button onclick="searchStocks()">검색</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div id="stockData" class="stock-data">
            <div class="stock-info">
                <div class="info-card">
                    <h3>Company Information</h3>
                    <div id="companyInfo"></div>
                </div>
                <div class="info-card">
                    <h3>Stock Price</h3>
                    <div id="priceInfo"></div>
                </div>
            </div>
            
            <div class="stock-info">
                <div class="info-card">
                    <h3>Financial Metrics</h3>
                    <div id="financialMetrics"></div>
                </div>
                <div class="info-card">
                    <h3>Analyst Recommendations</h3>
                    <div id="recommendations"></div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            
            <div class="stock-info">
                <div class="info-card">
                    <h3>📰 Company News</h3>
                    <div class="news-filter">
                        <button class="filter-btn active" onclick="filterNews('all')">전체</button>
                        <button class="filter-btn" onclick="filterNews('positive')">긍정 😊</button>
                        <button class="filter-btn" onclick="filterNews('negative')">부정 😟</button>
                        <button class="filter-btn" onclick="filterNews('neutral')">중립 😐</button>
                    </div>
                    <div id="newsSection">뉴스를 불러오려면 주식을 선택하세요.</div>
                </div>
                <div class="info-card">
                    <h3>💵 Dividend Information</h3>
                    <div id="dividendSection">배당 정보를 불러오려면 주식을 선택하세요.</div>
                </div>
            </div>
            
            <div class="info-card" style="margin-top: 20px;">
                <h3>🏢 Industry Peers Comparison</h3>
                <div id="peersSection">동종 업계 비교를 보려면 주식을 선택하세요.</div>
            </div>
            
            <div class="ai-analysis" style="margin-top: 30px;">
                <div class="info-card">
                    <h3>AI Investment Analysis</h3>
                    <button id="analyzeBtn" onclick="analyzeStock()" style="margin-bottom: 15px; padding: 10px 20px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">Start AI Analysis</button>
                    <div id="aiAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChart = null;
        let allNewsData = [];  // 전체 뉴스 데이터 저장
        let currentNewsFilter = 'all';  // 현재 뉴스 필터

        async function searchStocks() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!searchTerm) {
                alert('검색어를 입력해주세요.');
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">검색 중...</div>';

            try {
                // localStorage에서 API 키 가져오기
                const apiKey = localStorage.getItem('FINNHUB_API_KEY');
                if (!apiKey) {
                    alert('Finnhub API 키가 설정되지 않았습니다.\n설정 페이지에서 API 키를 입력해주세요.');
                    window.location.href = '/settings';
                    return;
                }
                
                const response = await fetch('/api/us_stocks/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        search_term: searchTerm,
                        api_key: apiKey  // API 키 전달
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displaySearchResults(data.results);
                } else {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">검색 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="error">검색 결과가 없습니다.</div>';
                return;
            }

            let html = '<h4>검색 결과:</h4>';
            results.forEach(stock => {
                html += `
                    <div class="stock-item" onclick="loadStockData('${stock.symbol}')">
                        <strong>${stock.symbol}</strong> - ${stock.description}
                        <br><small>${stock.type}</small>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        async function loadStockData(symbol) {
            const stockDataDiv = document.getElementById('stockData');
            const companyInfoDiv = document.getElementById('companyInfo');
            const priceInfoDiv = document.getElementById('priceInfo');
            const financialMetricsDiv = document.getElementById('financialMetrics');
            const recommendationsDiv = document.getElementById('recommendations');

            // 로딩 표시
            companyInfoDiv.innerHTML = '<div class="loading">데이터 로딩 중...</div>';
            priceInfoDiv.innerHTML = '<div class="loading">데이터 로딩 중...</div>';
            financialMetricsDiv.innerHTML = '<div class="loading">재무 지표 로딩 중...</div>';
            recommendationsDiv.innerHTML = '<div class="loading">분석가 추천 로딩 중...</div>';
            document.getElementById('newsSection').innerHTML = '<div class="loading">뉴스 로딩 중...</div>';
            document.getElementById('dividendSection').innerHTML = '<div class="loading">배당 정보 로딩 중...</div>';
            document.getElementById('peersSection').innerHTML = '<div class="loading">동종 업계 로딩 중...</div>';
            stockDataDiv.style.display = 'block';

            try {
                // localStorage에서 API 키 가져오기
                const apiKey = localStorage.getItem('FINNHUB_API_KEY');
                if (!apiKey) {
                    alert('Finnhub API 키가 설정되지 않았습니다.\n설정 페이지에서 API 키를 입력해주세요.');
                    window.location.href = '/settings';
                    return;
                }
                
                const response = await fetch('/api/us_stocks/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        symbol: symbol,
                        api_key: apiKey  // API 키 전달
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayStockData(data);
                    // 추가 데이터 로드
                    loadNews(symbol);
                    loadDividends(symbol);
                    loadPeers(symbol);
                } else {
                    companyInfoDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    priceInfoDiv.innerHTML = '';
                    financialMetricsDiv.innerHTML = '';
                    recommendationsDiv.innerHTML = '';
                }
            } catch (error) {
                companyInfoDiv.innerHTML = `<div class="error">데이터 로딩 중 오류가 발생했습니다: ${error.message}</div>`;
                priceInfoDiv.innerHTML = '';
                financialMetricsDiv.innerHTML = '';
                recommendationsDiv.innerHTML = '';
            }
        }

        function displayStockData(data) {
            // 현재 주식 데이터 저장 (AI 분석용)
            currentStockData = data;
            
            const companyInfo = data.company_info;
            const priceInfo = data.price_info;
            const financialMetrics = data.financial_metrics;
            const historicalData = data.historical_data;
            const recommendations = data.recommendations;

            // 기업 정보 표시
            document.getElementById('companyInfo').innerHTML = `
                <div class="info-item">
                    <span>심볼:</span>
                    <span><strong>${companyInfo.symbol}</strong></span>
                </div>
                <div class="info-item">
                    <span>회사명:</span>
                    <span>${companyInfo.name}</span>
                </div>
                <div class="info-item">
                    <span>국가:</span>
                    <span>${companyInfo.country}</span>
                </div>
                <div class="info-item">
                    <span>거래소:</span>
                    <span>${companyInfo.exchange}</span>
                </div>
                <div class="info-item">
                    <span>산업:</span>
                    <span>${companyInfo.industry}</span>
                </div>
                <div class="info-item">
                    <span>시가총액:</span>
                    <span>${companyInfo.market_capitalization ? '$' + (companyInfo.market_capitalization / 1000).toFixed(2) + 'B' : 'N/A'}</span>
                </div>
            `;

            // 주가 정보 표시
            document.getElementById('priceInfo').innerHTML = `
                <div class="info-item">
                    <span>현재가:</span>
                    <span><strong>$${priceInfo.current_price.toFixed(2)}</strong></span>
                </div>
                <div class="info-item">
                    <span>변동:</span>
                    <span style="color: ${priceInfo.change >= 0 ? 'green' : 'red'}">
                        ${priceInfo.change >= 0 ? '+' : ''}$${priceInfo.change.toFixed(2)} (${priceInfo.percent_change.toFixed(2)}%)
                    </span>
                </div>
                <div class="info-item">
                    <span>고가:</span>
                    <span>$${priceInfo.high.toFixed(2)}</span>
                </div>
                <div class="info-item">
                    <span>저가:</span>
                    <span>$${priceInfo.low.toFixed(2)}</span>
                </div>
                <div class="info-item">
                    <span>시가:</span>
                    <span>$${priceInfo.open.toFixed(2)}</span>
                </div>
                <div class="info-item">
                    <span>전일종가:</span>
                    <span>$${priceInfo.previous_close.toFixed(2)}</span>
                </div>
            `;

            // 재무 지표 표시
            document.getElementById('financialMetrics').innerHTML = `
                <div class="info-item">
                    <span>P/E 비율:</span>
                    <span>${financialMetrics.pe_ratio ? financialMetrics.pe_ratio.toFixed(2) : 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span>P/B 비율:</span>
                    <span>${financialMetrics.pb_ratio ? financialMetrics.pb_ratio.toFixed(2) : 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span>ROE:</span>
                    <span>${financialMetrics.roe ? (financialMetrics.roe * 100).toFixed(2) + '%' : 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span>부채비율:</span>
                    <span>${financialMetrics.debt_to_equity ? financialMetrics.debt_to_equity.toFixed(2) : 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span>배당수익률:</span>
                    <span>${financialMetrics.dividend_yield ? (financialMetrics.dividend_yield * 100).toFixed(2) + '%' : 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span>베타:</span>
                    <span>${financialMetrics.beta ? financialMetrics.beta.toFixed(2) : 'N/A'}</span>
                </div>
            `;

            // 분석가 추천 표시
            if (recommendations && recommendations.length > 0) {
                const latest = recommendations[0];
                document.getElementById('recommendations').innerHTML = `
                    <div class="info-item">
                        <span>기간:</span>
                        <span>${latest.period || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span>강력매수:</span>
                        <span>${latest.strongBuy || 0}명</span>
                    </div>
                    <div class="info-item">
                        <span>매수:</span>
                        <span>${latest.buy || 0}명</span>
                    </div>
                    <div class="info-item">
                        <span>보유:</span>
                        <span>${latest.hold || 0}명</span>
                    </div>
                    <div class="info-item">
                        <span>매도:</span>
                        <span>${latest.sell || 0}명</span>
                    </div>
                `;
            } else {
                document.getElementById('recommendations').innerHTML = '<div class="info-item">분석가 추천 데이터가 없습니다.</div>';
            }

            // 차트 그리기
            if (historicalData && historicalData.length > 0) {
                drawPriceChart(historicalData, companyInfo.symbol);
            } else {
                // 차트 데이터가 없을 때 메시지 표시
                const ctx = document.getElementById('priceChart').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#ffc107';
                ctx.textAlign = 'center';
                ctx.fillText('차트 데이터를 불러오는 중입니다...', ctx.canvas.width / 2, ctx.canvas.height / 2);
                ctx.fillText('Yahoo Finance에서 데이터를 가져오고 있습니다.', ctx.canvas.width / 2, ctx.canvas.height / 2 + 25);
            }
        }

        function drawPriceChart(historicalData, ticker) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // 기존 차트 제거
            if (currentChart) {
                currentChart.destroy();
            }

            // 데이터 검증
            if (!historicalData || historicalData.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('차트 데이터를 불러오는 중...', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const labels = historicalData.map(item => item.date);
            const prices = historicalData.map(item => item.close);

            // 가격 데이터 검증
            const validPrices = prices.filter(price => price && !isNaN(price));
            if (validPrices.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#dc3545';
                ctx.textAlign = 'center';
                ctx.fillText('유효한 가격 데이터가 없습니다', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${ticker} 주가`,
                        data: prices,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${ticker} Stock Price (Last 3 Months)`,
                            font: {
                                size: 16,
                                weight: 600
                            },
                            color: '#2d3748'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '주가 (USD)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '날짜'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        let currentStockData = null;

        async function analyzeStock() {
            if (!currentStockData) {
                alert('먼저 주식을 선택해주세요.');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const aiAnalysisDiv = document.getElementById('aiAnalysis');
            
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analyzing...';
            aiAnalysisDiv.innerHTML = '<div class="loading">Analyzing data with AI... (30-60 seconds)</div>';

            try {
                const response = await fetch('/api/analyze_us_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_data: currentStockData,
                        symbol: currentStockData.company_info.symbol
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    aiAnalysisDiv.innerHTML = `
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; font-weight: 600; margin-bottom: 16px;">${data.symbol} (${data.company_name}) - AI Analysis</h4>
                            <div style="white-space: pre-line; line-height: 1.7; margin-top: 12px; color: #4a5568;">
                                ${data.analysis}
                            </div>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                                <small style="color: #718096; display: block;">
                                    Model: ${data.model_used}
                                </small>
                                <small style="color: #718096; display: block; margin-top: 4px;">
                                    Disclaimer: This analysis is for reference only. Please make investment decisions carefully.
                                </small>
                            </div>
                        </div>
                    `;
                } else {
                    aiAnalysisDiv.innerHTML = `<div class="error">AI 분석 실패: ${data.error}</div>`;
                }
            } catch (error) {
                aiAnalysisDiv.innerHTML = `<div class="error">AI 분석 중 오류가 발생했습니다: ${error.message}</div>`;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'AI 분석 시작';
            }
        }

        async function loadNews(symbol) {
            const newsSection = document.getElementById('newsSection');
            
            try {
                const response = await fetch('/api/us_stocks/news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                if (response.ok && data.news && data.news.length > 0) {
                    allNewsData = data.news;  // 전체 뉴스 저장
                    displayFilteredNews(currentNewsFilter);
                } else {
                    newsSection.innerHTML = '<div class="info-item">최근 뉴스가 없습니다.</div>';
                }
            } catch (error) {
                newsSection.innerHTML = `<div class="error">뉴스 로딩 실패: ${error.message}</div>`;
            }
        }

        function filterNews(filter) {
            currentNewsFilter = filter;
            
            // 필터 버튼 활성화 상태 변경
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayFilteredNews(filter);
        }

        function displayFilteredNews(filter) {
            const newsSection = document.getElementById('newsSection');
            
            let filteredNews = allNewsData;
            
            // 필터 적용
            if (filter === 'positive') {
                filteredNews = allNewsData.filter(article => (article.sentiment || 0) > 0);
            } else if (filter === 'negative') {
                filteredNews = allNewsData.filter(article => (article.sentiment || 0) < 0);
            } else if (filter === 'neutral') {
                filteredNews = allNewsData.filter(article => (article.sentiment || 0) === 0);
            }
            
            if (filteredNews.length === 0) {
                newsSection.innerHTML = '<div class="info-item">해당 필터에 맞는 뉴스가 없습니다.</div>';
                return;
            }
            
            let html = '';
            filteredNews.slice(0, 10).forEach(article => {
                const date = new Date(article.datetime * 1000).toLocaleDateString('ko-KR');
                const sentiment = article.sentiment || 0;
                const sentimentClass = sentiment > 0 ? 'sentiment-positive' : sentiment < 0 ? 'sentiment-negative' : 'sentiment-neutral';
                const sentimentText = sentiment > 0 ? '긍정' : sentiment < 0 ? '부정' : '중립';
                
                html += `
                    <div class="news-item">
                        <h4><a href="${article.url}" target="_blank">${article.headline}</a></h4>
                        <div class="news-summary">${article.summary || ''}</div>
                        <div class="news-meta">
                            ${date} | ${article.source} | 감성: <span class="${sentimentClass}">${sentimentText}</span>
                        </div>
                    </div>
                `;
            });
            newsSection.innerHTML = html;
        }

        let dividendChart = null;

        async function loadDividends(symbol) {
            const dividendSection = document.getElementById('dividendSection');
            
            try {
                const response = await fetch('/api/us_stocks/dividends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                if (response.ok && data.dividends && data.dividends.history) {
                    const dividends = data.dividends;
                    const currentPrice = currentStockData?.price_info?.current_price || 0;
                    const dividendYield = currentPrice > 0 ? (dividends.annual_dividend / currentPrice * 100) : 0;
                    
                    // 배당 성장률 표시
                    const growthRate = dividends.growth_rate || 0;
                    const growthClass = growthRate > 0 ? 'positive' : growthRate < 0 ? 'negative' : '';
                    const growthDisplay = growthRate !== 0 ? `<span class="dividend-growth ${growthClass}">${growthRate > 0 ? '+' : ''}${growthRate.toFixed(2)}%</span>` : 'N/A';
                    
                    let html = `
                        <div class="info-item">
                            <span>최근 배당금:</span>
                            <span><strong>$${dividends.latest_dividend.toFixed(4)}</strong></span>
                        </div>
                        <div class="info-item">
                            <span>연간 배당금 (추정):</span>
                            <span><strong>$${dividends.annual_dividend.toFixed(2)}</strong></span>
                        </div>
                        <div class="info-item">
                            <span>배당 수익률:</span>
                            <span><strong>${dividendYield.toFixed(2)}%</strong></span>
                        </div>
                        <div class="info-item">
                            <span>배당 성장률 (연평균):</span>
                            <span>${growthDisplay}</span>
                        </div>
                        <div class="info-item">
                            <span>배당 주기:</span>
                            <span><strong>${dividends.dividend_frequency}</strong></span>
                        </div>
                    `;
                    
                    // 배당 캘린더 (다음 배당일)
                    if (dividends.next_dividend_date) {
                        html += `
                            <div class="dividend-calendar">
                                <strong>📅 다음 배당일 예상:</strong> ${dividends.next_dividend_date}
                                <br><small style="color: #718096; margin-top: 4px; display: block;">
                                    * 과거 배당 주기를 기반으로 한 예측이며 실제와 다를 수 있습니다.
                                </small>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="dividend-chart">
                            <canvas id="dividendChart"></canvas>
                        </div>
                    `;
                    
                    dividendSection.innerHTML = html;
                    
                    // 배당 히스토리 차트
                    setTimeout(() => {
                        const ctx = document.getElementById('dividendChart').getContext('2d');
                        if (dividendChart) {
                            dividendChart.destroy();
                        }
                        
                        const labels = dividends.history.map(d => d.date);
                        const amounts = dividends.history.map(d => d.amount);
                        
                        dividendChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: '배당금 ($)',
                                    data: amounts,
                                    backgroundColor: 'rgba(49, 130, 206, 0.6)',
                                    borderColor: '#3182ce',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '배당 히스토리',
                                        font: { size: 14, weight: 600 }
                                    },
                                    legend: { display: false }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: { display: true, text: '배당금 ($)' }
                                    }
                                }
                            }
                        });
                    }, 100);
                } else {
                    dividendSection.innerHTML = '<div class="info-item">배당 정보가 없습니다. (무배당 주식)</div>';
                }
            } catch (error) {
                dividendSection.innerHTML = `<div class="error">배당 정보 로딩 실패: ${error.message}</div>`;
            }
        }

        async function loadPeers(symbol) {
            const peersSection = document.getElementById('peersSection');
            
            try {
                const response = await fetch('/api/us_stocks/peers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const data = await response.json();

                if (response.ok && data.peers && data.peers.length > 0) {
                    let html = `
                        <p style="margin-bottom: 15px; color: #718096;">
                            ${symbol}와 같은 산업군의 기업들과 주요 지표를 비교합니다.
                        </p>
                        <table class="peers-table">
                            <thead>
                                <tr>
                                    <th>기업</th>
                                    <th>현재가</th>
                                    <th>변동률</th>
                                    <th>시가총액 (B)</th>
                                    <th>P/E</th>
                                    <th>P/B</th>
                                    <th>ROE (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // 현재 주식 정보 추가
                    if (currentStockData) {
                        const info = currentStockData.company_info;
                        const price = currentStockData.price_info;
                        const metrics = currentStockData.financial_metrics;
                        
                        html += `
                            <tr style="background: #edf2f7; font-weight: 600;">
                                <td>${info.symbol} (현재)</td>
                                <td>$${price.current_price.toFixed(2)}</td>
                                <td class="${price.percent_change >= 0 ? 'positive' : 'negative'}">
                                    ${price.percent_change >= 0 ? '+' : ''}${price.percent_change.toFixed(2)}%
                                </td>
                                <td>${(info.market_capitalization / 1000).toFixed(2)}</td>
                                <td>${metrics.pe_ratio ? metrics.pe_ratio.toFixed(2) : 'N/A'}</td>
                                <td>${metrics.pb_ratio ? metrics.pb_ratio.toFixed(2) : 'N/A'}</td>
                                <td>${metrics.roe ? (metrics.roe * 100).toFixed(2) : 'N/A'}</td>
                            </tr>
                        `;
                    }
                    
                    // 동종 업계 기업들
                    data.peers.forEach(peer => {
                        html += `
                            <tr>
                                <td><strong>${peer.symbol}</strong><br><small>${peer.name}</small></td>
                                <td>$${peer.current_price.toFixed(2)}</td>
                                <td class="${peer.change_percent >= 0 ? 'positive' : 'negative'}">
                                    ${peer.change_percent >= 0 ? '+' : ''}${peer.change_percent.toFixed(2)}%
                                </td>
                                <td>${(peer.market_cap / 1000).toFixed(2)}</td>
                                <td>${peer.pe_ratio ? peer.pe_ratio.toFixed(2) : 'N/A'}</td>
                                <td>${peer.pb_ratio ? peer.pb_ratio.toFixed(2) : 'N/A'}</td>
                                <td>${peer.roe ? (peer.roe * 100).toFixed(2) : 'N/A'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    peersSection.innerHTML = html;
                } else {
                    peersSection.innerHTML = '<div class="info-item">동종 업계 정보가 없습니다.</div>';
                }
            } catch (error) {
                peersSection.innerHTML = `<div class="error">동종 업계 로딩 실패: ${error.message}</div>`;
            }
        }

        // 엔터키로 검색
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStocks();
            }
        });
    </script>
</body>
</html>